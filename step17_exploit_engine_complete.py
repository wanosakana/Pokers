# step17_exploit_engine_complete.py
from typing import Dict, List, Optional, Tuple
from dataclasses import dataclass
from enum import Enum

class ExploitType(Enum):
    OVERFOLDING = "Overfolds to aggression"
    OVERCALLING = "Calls too much"
    PASSIVE = "Too passive postflop"
    OVERLY_AGGRESSIVE = "Bluffs too much"
    PREDICTABLE_BETTING = "Predictable bet sizing"
    POSITION_UNAWARE = "Doesn't adjust for position"
    POOR_BLUFF_CATCHING = "Folds too much to river bets"

@dataclass
class ExploitRecommendation:
    """エクスプロイト推奨"""
    exploit_type: ExploitType
    confidence: float  # 0-1
    description: str
    strategy_adjustment: str
    expected_ev_gain: float

class AdvancedExploitEngine:
    """高度なエクスプロイト検出エンジン"""
    
    def __init__(self, hud_tracker):
        self.hud = hud_tracker
        self.minimum_hands = 50
    
    def detect_exploits(self, player_id: str) -> List[ExploitRecommendation]:
        """全エクスプロイトを検出"""
        stats = self.hud.get_or_create_player(player_id)
        
        if stats.hands_played < self.minimum_hands:
            return []
        
        exploits = []
        
        # 1. Fold to CBet過剰
        exploits.extend(self._detect_cbet_exploits(stats))
        
        # 2. VPIP/PFR不均衡
        exploits.extend(self._detect_vpip_pfr_exploits(stats))
        
        # 3. アグレッション不均衡
        exploits.extend(self._detect_aggression_exploits(stats))
        
        # 4. ポジション認識の欠如
        exploits.extend(self._detect_position_exploits(stats))
        
        # 5. ベットサイジングパターン
        exploits.extend(self._detect_sizing_exploits(stats))
        
        # 6. ショーダウン傾向
        exploits.extend(self._detect_showdown_exploits(stats))
        
        # 信頼度でソート
        exploits.sort(key=lambda x: x.confidence, reverse=True)
        
        return exploits
    
    def _detect_cbet_exploits(self, stats) -> List[ExploitRecommendation]:
        """CBet関連のエクスプロイト"""
        exploits = []
        
        # Fold to CBet過剰
        fold_to_cbet_flop = stats.get_fold_to_cbet('flop')
        if fold_to_cbet_flop > 0.70 and stats.faced_cbet['flop'] > 20:
            confidence = min(1.0, (fold_to_cbet_flop - 0.65) * 2)
            exploits.append(ExploitRecommendation(
                exploit_type=ExploitType.OVERFOLDING,
                confidence=confidence,
                description=f"Folds to flop CBet {fold_to_cbet_flop:.0%} of the time",
                strategy_adjustment="CBet 100% of your range, even air. Size down to 33% pot for max profit",
                expected_ev_gain=15.0 * confidence
            ))
        
        # CBet過剰
        cbet_freq = stats.get_cbet_frequency('flop')
        if cbet_freq > 0.85 and stats.cbet_opportunities['flop'] > 20:
            confidence = min(1.0, (cbet_freq - 0.75) * 2)
            exploits.append(ExploitRecommendation(
                exploit_type=ExploitType.OVERLY_AGGRESSIVE,
                confidence=confidence,
                description=f"CBets flop {cbet_freq:.0%} of the time",
                strategy_adjustment="Float more IP, check-raise more OOP. Their range is weak",
                expected_ev_gain=12.0 * confidence
            ))
        
        return exploits
    
    def _detect_vpip_pfr_exploits(self, stats) -> List[ExploitRecommendation]:
        """VPIP/PFR不均衡"""
        exploits = []
        
        vpip = stats.vpip
        pfr = stats.pfr
        
        # 極端なルースパッシブ
        if vpip > 0.40 and pfr / vpip < 0.4:
            confidence = min(1.0, vpip - 0.35)
            exploits.append(ExploitRecommendation(
                exploit_type=ExploitType.OVERCALLING,
                confidence=confidence,
                description=f"VPIP {vpip:.0%}, PFR {pfr:.0%} - Calling station",
                strategy_adjustment="Value bet thinly on all streets. Avoid bluffing. Never fold top pair",
                expected_ev_gain=20.0 * confidence
            ))
        
        # 極端なタイト
        if vpip < 0.15:
            confidence = min(1.0, (0.18 - vpip) * 5)
            exploits.append(ExploitRecommendation(
                exploit_type=ExploitType.OVERFOLDING,
                confidence=confidence,
                description=f"VPIP only {vpip:.0%} - Ultra tight",
                strategy_adjustment="Steal blinds relentlessly. 3-bet light. When they show strength, give up",
                expected_ev_gain=18.0 * confidence
            ))
        
        return exploits
    
    def _detect_aggression_exploits(self, stats) -> List[ExploitRecommendation]:
        """アグレッション不均衡"""
        exploits = []
        
        af = stats.aggression_factor
        
        # 極端にパッシブ
        if af < 1.0 and stats.hands_played > 100:
            confidence = min(1.0, (1.5 - af))
            exploits.append(ExploitRecommendation(
                exploit_type=ExploitType.PASSIVE,
                confidence=confidence,
                description=f"Aggression Factor {af:.2f} - Very passive",
                strategy_adjustment="Bluff more, especially on turn/river. Bet merge your range",
                expected_ev_gain=16.0 * confidence
            ))
        
        # 極端にアグレッシブ
        if af > 5.0 and stats.hands_played > 100:
            confidence = min(1.0, (af - 4.0) / 3.0)
            exploits.append(ExploitRecommendation(
                exploit_type=ExploitType.OVERLY_AGGRESSIVE,
                confidence=confidence,
                description=f"Aggression Factor {af:.2f} - Maniac",
                strategy_adjustment="Call down lighter. Check-raise for value. Trap with monsters",
                expected_ev_gain=25.0 * confidence
            ))
        
        return exploits
    
    def _detect_position_exploits(self, stats) -> List[ExploitRecommendation]:
        """ポジション認識の欠如"""
        exploits = []
        
        btn_vpip = stats.get_position_vpip('BTN')
        utg_vpip = stats.get_position_vpip('UTG')
        
        if utg_vpip > 0 and btn_vpip / utg_vpip < 1.5:
            confidence = min(1.0, (1.8 - btn_vpip / utg_vpip))
            exploits.append(ExploitRecommendation(
                exploit_type=ExploitType.POSITION_UNAWARE,
                confidence=confidence,
                description=f"BTN VPIP {btn_vpip:.0%} vs UTG {utg_vpip:.0%} - Not position aware",
                strategy_adjustment="3-bet lighter IP, float more, apply more pressure",
                expected_ev_gain=14.0 * confidence
            ))
        
        return exploits
    
    def _detect_sizing_exploits(self, stats) -> List[ExploitRecommendation]:
        """ベットサイジングパターン"""
        exploits = []
        
        if len(stats.bet_sizes) > 30:
            avg_size = sum(stats.bet_sizes) / len(stats.bet_sizes)
            
            # 極端に小さいベット
            if avg_size < 0.4:
                exploits.append(ExploitRecommendation(
                    exploit_type=ExploitType.PREDICTABLE_BETTING,
                    confidence=0.7,
                    description=f"Average bet size {avg_size:.1f}x pot - Too small",
                    strategy_adjustment="Raise their small bets frequently. They're likely weak",
                    expected_ev_gain=10.0
                ))
            
            # 極端に大きいベット
            elif avg_size > 1.2:
                exploits.append(ExploitRecommendation(
                    exploit_type=ExploitType.PREDICTABLE_BETTING,
                    confidence=0.7,
                    description=f"Average bet size {avg_size:.1f}x pot - Overbetting",
                    strategy_adjustment="Fold more to overbets unless nutted. They're polarized",
                    expected_ev_gain=12.0
                ))
        
        return exploits
    
    def _detect_showdown_exploits(self, stats) -> List[ExploitRecommendation]:
        """ショーダウン傾向"""
        exploits = []
        
        wtsd = stats.get_wtsd()
        wssd = stats.get_wssd()
        
        # ショーダウンまで行き過ぎ
        if wtsd > 0.35 and stats.vpip_count > 50:
            confidence = min(1.0, (wtsd - 0.30) * 2)
            exploits.append(ExploitRecommendation(
                exploit_type=ExploitType.POOR_BLUFF_CATCHING,
                confidence=confidence,
                description=f"WTSD {wtsd:.0%} - Goes to showdown too much",
                strategy_adjustment="Value bet thinner. Avoid bluffing river unless board changes",
                expected_ev_gain=13.0 * confidence
            ))
        
        return exploits
    
    def calculate_exploit_value(self, player_id: str, situation: str) -> float:
        """特定の状況でのエクスプロイト価値"""
        exploits = self.detect_exploits(player_id)
        
        if not exploits:
            return 0.0
        
        total_ev = sum(e.expected_ev_gain * e.confidence for e in exploits)
        return total_ev / len(exploits)
